---

  - name: SAP HANA Post Install - Include firewall specific vars
    ansible.builtin.include_vars: firewall_vars.yml
    tags: sap_hana_install_configure_firewall

  - name: SAP HANA Post Install - Enable and start the firewalld service
    ansible.builtin.systemd:
      name: firewalld
      state: started
      enabled: yes
    tags: sap_hana_install_configure_firewall

  - name: SAP HANA Post Install - Construct the argument list for firewall-cmd
    ansible.builtin.set_fact:
      __sap_hana_install_fact_firewall_cmd_args:
        "{{ ['--add-port='] | product(firewall[0].port) | map('join') | list }}"
    tags: sap_hana_install_configure_firewall

  - name: SAP HANA Post Install - Set fact for the firewall-cmd command
    ansible.builtin.set_fact:
      __sap_hana_install_fact_firewall_cmd_command:
        "firewall-cmd --zone=public {{ __sap_hana_install_fact_firewall_cmd_args | map('quote') | join(' ') }}"
    tags: sap_hana_install_configure_firewall

  - name: SAP HANA Post Install - Display the firewall-cmd command
    ansible.builtin.debug:
      var: __sap_hana_install_fact_firewall_cmd_command
    tags: sap_hana_install_configure_firewall

# No matter if the ports have already been enabled or not, the changed state
# of the command is always true. For avoiding ansible-lint to report a violation
# of the no-changed-when rule, we just set changed_when to true here.
  - name: SAP HANA Post Install - Enable the required ports immediately
    ansible.builtin.command: "{{ __sap_hana_install_fact_firewall_cmd_command }}"
    changed_when: yes
    tags: sap_hana_install_configure_firewall

# No matter if the ports have already been enabled or not, the changed state
# of the command is always true. For avoiding ansible-lint to report a violation
# of the no-changed-when rule, we just set changed_when to true here.
  - name: SAP HANA Post Install - Enable the required ports permanently
    ansible.builtin.command: "{{ __sap_hana_install_fact_firewall_cmd_command }} --permanent"
    changed_when: yes
    tags: sap_hana_install_configure_firewall
