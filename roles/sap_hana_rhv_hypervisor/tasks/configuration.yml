---
# tasks file for sap_hana_rhv_hypervisor

- name: Test if kernel same page merging (KSM) exists
  shell: systemctl cat ksm
  register: ksm
  ignore_errors: yes

- name: Test if kernel same page merging (KSM) tuning daemon exists
  shell: systemctl cat ksmtuned
  register: ksmtuned
  ignore_errors: yes

- name: Stop kernel same page merging (KSM)
  shell: systemctl stop ksm
  when: ksm.rc == 0

- name: Disable kernel same page merging (KSM)
  shell: systemctl disable ksm
  when: ksm.rc == 0

- name: Stop Kernel Samepage Merging (KSM) Tuning Daemon
  shell: systemctl stop ksmtuned
  when: ksmtuned.rc == 0

- name: Disable Kernel Samepage Merging (KSM) Tuning Daemon
  shell: systemctl disable ksmtuned
  when: ksmtuned.rc == 0

- name: Check CPU Stepping
  shell: lscpu | awk '/Stepping/{print $2}'
  register: cpu_stepping_output

- set_fact:
    cpu_stepping: "{{ cpu_stepping_output.stdout }}"

- name: Print CPU Stepping
  shell: echo "{{ cpu_stepping }}"

# skylake:
- name: Set ple_gap=0 on Intel Skylake CPU Platform
  lineinfile:
    path: /etc/modprobe.d/kvm.conf
    line: options kvm_intel ple_gap=0
  when: cpu_stepping == "4"

# skylake
- name: Set spectre_v2=retpoline on Intel Skylake CPU Platform
  lineinfile:
    path: /etc/default/grub
    backup: yes
    backrefs: yes
    state: present
    regexp: '^(GRUB_CMDLINE_LINUX=(?!.* {{ item }}).*). *$'
    line: "\\1 {{ item }}\""
  with_items:
    - "spectre_v2=retpoline"
  notify: "Regenerate grub2 conf handler"
  tags: grubconfig
  when: cpu_stepping == "4"

- name: "Set kvm.nx_huge_pages to {{ sap_hana_rhv_hypervisor_kvm_nx_huge_pages }}"
  lineinfile:
    path: /etc/default/grub
    backup: yes
    backrefs: yes
    state: present
    regexp: '^(GRUB_CMDLINE_LINUX=(?!.* {{ item }}).*). *$'
    line: "\\1 {{ item }}\""
  with_items:
    - "kvm.nx_huge_pages={{ sap_hana_rhv_hypervisor_kvm_nx_huge_pages }}"
  notify: "Regenerate grub2 conf handler"
  tags: grubconfig
  when: sap_hana_rhv_hypervisor_kvm_nx_huge_pages is defined

- name: Set seccomp_sanbox=0
  lineinfile:
    path: /etc/libvirt/qemu.conf
    backup: yes
    backrefs: yes
    state: present
    regexp: 'seccomp_sandbox'
    line: "seccomp_sandbox = 0"

- name: Trigger tuned profile sap-hana-kvm activation
  include_tasks: allocate-hugepages-at-runtime.yml
  when: sap_hana_rhv_hypervisor_reserve_hugepages == "runtime" 

- name: Reserve Hugepages statically
  lineinfile:
    path: /etc/default/grub
    backup: yes
    backrefs: yes
    state: present
    regexp: '^(GRUB_CMDLINE_LINUX=(?!.* {{ item }}).*). *$'
    line: "\\1 {{ item }}\""
  with_items:
    - default_hugepagesz=1GB
    - hugepagesz=1GB
    - hugepages={{ ( ansible_memtotal_mb / 1024 )|int - sap_hana_rhv_hypervisor_reserved_ram }}
  notify: "Regenerate grub2 conf handler"
  tags: grubconfig
  when: sap_hana_rhv_hypervisor_reserve_hugepages == "static"

- name: Enable IOMMU PT
  lineinfile:
    path: /etc/default/grub
    backup: yes
    backrefs: yes
    state: present
    regexp: '^(GRUB_CMDLINE_LINUX=(?!.* {{ item }}).*). *$'
    line: "\\1 {{ item }}\""
  with_items:
    - intel_iommu=on
    - iommu=pt
  notify: "Regenerate grub2 conf handler"
  tags: grubconfig

- name: Enable TSX
  lineinfile:
    path: /etc/default/grub
    backup: yes
    backrefs: yes
    state: present
    regexp: '^(GRUB_CMDLINE_LINUX=(?!.* {{ item }}).*). *$'
    line: "\\1 {{ item }}\""
  with_items:
     - "tsx={{ sap_hana_rhv_hypervisor_tsx }}"
  notify: "Regenerate grub2 conf handler"
  tags: grubconfig
...
